<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proxmox LoadBalancer | Dialogue Dynamics AI</title>
    <link rel="stylesheet" href="/static/css/style.css?v=27">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <script>
        // Check authentication on page load
        (function() {
            const token = localStorage.getItem('access_token');
            if (!token) {
                window.location.href = '/login';
            }
        })();
    </script>
    <div class="app-container">
        <!-- Sidebar Navigation -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon-container">
                        <svg class="logo-svg" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect x="4" y="8" width="40" height="8" rx="2" fill="url(#grad1)"/>
                            <rect x="4" y="20" width="40" height="8" rx="2" fill="url(#grad2)"/>
                            <rect x="4" y="32" width="40" height="8" rx="2" fill="url(#grad3)"/>
                            <circle cx="38" cy="12" r="3" fill="#10b981"/>
                            <circle cx="38" cy="24" r="3" fill="#10b981"/>
                            <circle cx="38" cy="36" r="3" fill="#f59e0b"/>
                            <defs>
                                <linearGradient id="grad1" x1="4" y1="12" x2="44" y2="12">
                                    <stop offset="0%" stop-color="#3b82f6"/>
                                    <stop offset="100%" stop-color="#8b5cf6"/>
                                </linearGradient>
                                <linearGradient id="grad2" x1="4" y1="24" x2="44" y2="24">
                                    <stop offset="0%" stop-color="#8b5cf6"/>
                                    <stop offset="100%" stop-color="#ec4899"/>
                                </linearGradient>
                                <linearGradient id="grad3" x1="4" y1="36" x2="44" y2="36">
                                    <stop offset="0%" stop-color="#ec4899"/>
                                    <stop offset="100%" stop-color="#f59e0b"/>
                                </linearGradient>
                            </defs>
                        </svg>
                    </div>
                    <div class="logo-text-container">
                        <span class="logo-text-main">Proxmox</span>
                        <span class="logo-text-accent">LoadBalancer</span>
                    </div>
                </div>
                <div class="brand-footer">
                    <span class="powered-by">powered by</span>
                    <span class="brand-name">Dialogue<em>Dynamics</em></span>
                </div>
            </div>
            
            <nav class="nav-menu">
                <a href="#" class="nav-item active" data-page="dashboard">
                    <span class="nav-icon">üìä</span>
                    <span class="nav-label">Dashboard</span>
                </a>
                <a href="#" class="nav-item" data-page="nodes">
                    <span class="nav-icon">üñ•Ô∏è</span>
                    <span class="nav-label">Nodes</span>
                </a>
                <a href="#" class="nav-item" data-page="guests">
                    <span class="nav-icon">üíª</span>
                    <span class="nav-label">Guests</span>
                </a>
                <a href="#" class="nav-item" data-page="balancing" data-role-action="tech">
                    <span class="nav-icon">‚ö°</span>
                    <span class="nav-label">Balancing</span>
                </a>
                <a href="#" class="nav-item" data-page="rules">
                    <span class="nav-icon">üìã</span>
                    <span class="nav-label">Rules</span>
                </a>
                <a href="#" class="nav-item" data-page="logs">
                    <span class="nav-icon">üìù</span>
                    <span class="nav-label">Logs</span>
                </a>
                <a href="#" class="nav-item" data-page="config" data-role="admin">
                    <span class="nav-icon">‚öôÔ∏è</span>
                    <span class="nav-label">Config</span>
                </a>
                <a href="#" class="nav-item" data-page="users" data-role="admin">
                    <span class="nav-icon">üë•</span>
                    <span class="nav-label">Users</span>
                </a>
                <a href="#" class="nav-item" data-page="settings" data-role="admin">
                    <span class="nav-icon">üîß</span>
                    <span class="nav-label">Settings</span>
                </a>
            </nav>
            
            <div class="sidebar-footer">
                <div class="service-status" id="service-status">
                    <span class="status-dot"></span>
                    <span class="status-text">Checking...</span>
                </div>
                
                <!-- User Profile -->
                <div class="user-profile" id="user-profile">
                    <div class="user-avatar-sm" id="user-avatar">?</div>
                    <div class="user-info-sm">
                        <span class="user-name-sm" id="user-display-name">Loading...</span>
                        <span class="user-role-sm" id="user-display-role">-</span>
                    </div>
                    <div class="user-menu-trigger" onclick="toggleUserMenu()">‚ñº</div>
                </div>
                
                <!-- User Menu Dropdown -->
                <div class="user-menu-dropdown" id="user-menu-dropdown" style="display: none;">
                    <a href="#" onclick="showChangePasswordModal(); return false;">
                        üîë Change Password
                    </a>
                    <a href="#" onclick="show2FASetupModal(); return false;">
                        üîê Setup 2FA
                    </a>
                    <hr>
                    <a href="#" onclick="logout(); return false;" class="logout-link">
                        üö™ Logout
                    </a>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Dashboard Page -->
            <section class="page active" id="page-dashboard">
                <header class="page-header">
                    <h1>Cluster <em>Dashboard</em></h1>
                    <div class="header-actions">
                        <span class="last-refresh" id="last-refresh"></span>
                        <button class="btn btn-secondary" onclick="refreshDashboard()">
                            <span>üîÑ</span> Refresh
                        </button>
                        <button class="btn btn-primary" onclick="triggerRebalance()">
                            <span>‚ö°</span> Rebalance Now
                        </button>
                    </div>
                </header>

                <div class="dashboard-grid">
                    <!-- Cluster Status Card -->
                    <div class="card cluster-status-card">
                        <div class="card-header">
                            <h3>Cluster Status</h3>
                            <span class="cluster-name" id="cluster-name">Loading...</span>
                        </div>
                        <div class="card-body">
                            <div class="status-grid">
                                <div class="status-item">
                                    <span class="status-value" id="node-count">-</span>
                                    <span class="status-label">Nodes <small>(online/total)</small></span>
                                </div>
                                <div class="status-item">
                                    <span class="status-value" id="vm-count">-</span>
                                    <span class="status-label">VMs <small>(running/total)</small></span>
                                </div>
                                <div class="status-item">
                                    <span class="status-value" id="ct-count">-</span>
                                    <span class="status-label">Containers <small>(running/total)</small></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Resource Gauges -->
                    <div class="card resource-card">
                        <div class="card-header">
                            <h3>Cluster Resources</h3>
                        </div>
                        <div class="card-body">
                            <div class="gauge-grid">
                                <div class="gauge-item">
                                    <div class="gauge" id="cpu-gauge">
                                        <svg viewBox="0 0 100 50">
                                            <path class="gauge-bg" d="M10,50 A40,40 0 0,1 90,50"/>
                                            <path class="gauge-fill" id="cpu-gauge-fill" d="M10,50 A40,40 0 0,1 90,50"/>
                                        </svg>
                                        <div class="gauge-value" id="cpu-value">-%</div>
                                    </div>
                                    <span class="gauge-label">CPU</span>
                                </div>
                                <div class="gauge-item">
                                    <div class="gauge" id="mem-gauge">
                                        <svg viewBox="0 0 100 50">
                                            <path class="gauge-bg" d="M10,50 A40,40 0 0,1 90,50"/>
                                            <path class="gauge-fill" id="mem-gauge-fill" d="M10,50 A40,40 0 0,1 90,50"/>
                                        </svg>
                                        <div class="gauge-value" id="mem-value">-%</div>
                                    </div>
                                    <span class="gauge-label">Memory</span>
                                </div>
                                <div class="gauge-item">
                                    <div class="gauge" id="disk-gauge">
                                        <svg viewBox="0 0 100 50">
                                            <path class="gauge-bg" d="M10,50 A40,40 0 0,1 90,50"/>
                                            <path class="gauge-fill" id="disk-gauge-fill" d="M10,50 A40,40 0 0,1 90,50"/>
                                        </svg>
                                        <div class="gauge-value" id="disk-value">-%</div>
                                    </div>
                                    <span class="gauge-label">Disk</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Next Run Card -->
                    <div class="card next-run-card">
                        <div class="card-header">
                            <h3>ProxLB Status</h3>
                        </div>
                        <div class="card-body">
                            <div class="next-run-info">
                                <div class="next-run-timer" id="next-run-container">
                                    <span class="timer-label" id="next-run-label">Next Rebalance</span>
                                    <span class="timer-value" id="next-run-timer">Loading...</span>
                                </div>
                                <div class="balancing-info">
                                    <span class="info-item">
                                        <span class="info-label">Method:</span>
                                        <span class="info-value" id="balance-method">-</span>
                                    </span>
                                    <span class="info-item">
                                        <span class="info-label">Mode:</span>
                                        <span class="info-value" id="balance-mode">-</span>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Nodes Overview -->
                    <div class="card nodes-overview-card">
                        <div class="card-header">
                            <h3>Nodes Overview</h3>
                            <a href="#" class="card-link" data-page="nodes">View All ‚Üí</a>
                        </div>
                        <div class="card-body">
                            <div class="nodes-grid" id="nodes-grid">
                                <!-- Nodes will be populated here -->
                            </div>
                        </div>
                    </div>

                    <!-- Recent Migrations -->
                    <div class="card migrations-card">
                        <div class="card-header">
                            <h3>Recent Migrations</h3>
                            <a href="#" class="card-link" data-page="logs">View Logs ‚Üí</a>
                        </div>
                        <div class="card-body">
                            <div class="migration-list" id="migration-list">
                                <!-- Migrations will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Nodes Page -->
            <section class="page" id="page-nodes">
                <header class="page-header">
                    <h1>Cluster <em>Nodes</em></h1>
                    <div class="header-actions">
                        <button class="btn btn-secondary" onclick="refreshNodes()">
                            <span>üîÑ</span> Refresh
                        </button>
                    </div>
                </header>
                
                <div class="nodes-summary" id="nodes-summary">
                    <!-- Summary will be populated here -->
                </div>

                <div class="nodes-container" id="nodes-container">
                    <!-- Node cards will be populated here -->
                </div>
            </section>

            <!-- Guests Page -->
            <section class="page" id="page-guests">
                <header class="page-header">
                    <h1>Virtual Machines & <em>Containers</em></h1>
                    <div class="header-actions">
                        <button class="btn btn-secondary" onclick="refreshGuests()">
                            <span>üîÑ</span> Refresh
                        </button>
                    </div>
                </header>
                
                <!-- Filter Bar -->
                <div class="filter-bar">
                    <div class="filter-group">
                        <label>Search</label>
                        <input type="text" class="search-input" id="guest-search" placeholder="Search by name or ID...">
                    </div>
                    <div class="filter-group">
                        <label>Status</label>
                        <div class="filter-toggles">
                            <button class="filter-toggle active" data-filter="status" data-value="all" onclick="setStatusFilter('all')">
                                All
                            </button>
                            <button class="filter-toggle" data-filter="status" data-value="running" onclick="setStatusFilter('running')">
                                <span class="status-indicator online"></span> Online
                            </button>
                            <button class="filter-toggle" data-filter="status" data-value="stopped" onclick="setStatusFilter('stopped')">
                                <span class="status-indicator offline"></span> Offline
                            </button>
                        </div>
                    </div>
                    <div class="filter-group">
                        <label>Type</label>
                        <div class="filter-toggles">
                            <button class="filter-toggle active" data-filter="type" data-value="all" onclick="setTypeFilter('all')">
                                All
                            </button>
                            <button class="filter-toggle" data-filter="type" data-value="qemu" onclick="setTypeFilter('qemu')">
                                üíª VMs
                            </button>
                            <button class="filter-toggle" data-filter="type" data-value="lxc" onclick="setTypeFilter('lxc')">
                                üì¶ Containers
                            </button>
                        </div>
                    </div>
                    <div class="filter-group">
                        <label>Node</label>
                        <select class="filter-select" id="guest-node-filter">
                            <option value="all">All Nodes</option>
                        </select>
                    </div>
                </div>
                
                <!-- Filter Summary -->
                <div class="filter-summary" id="filter-summary">
                    Showing <span id="filtered-count">0</span> of <span id="total-count">0</span> guests
                </div>

                <div class="table-container">
                    <table class="data-table" id="guests-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Node</th>
                                <th>Status</th>
                                <th>CPU</th>
                                <th>Memory</th>
                                <th>Tags</th>
                            </tr>
                        </thead>
                        <tbody id="guests-tbody">
                            <!-- Guests will be populated here -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Balancing Page -->
            <section class="page" id="page-balancing">
                <header class="page-header">
                    <h1>Balancing Control</h1>
                </header>

                <div class="balancing-grid">
                    <div class="card">
                        <div class="card-header">
                            <h3>Balancing Settings</h3>
                        </div>
                        <div class="card-body">
                            <form id="balancing-form" class="settings-form">
                                <div class="form-group">
                                    <label>Balancing Enabled</label>
                                    <label class="toggle">
                                        <input type="checkbox" id="balancing-enabled" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="form-group">
                                    <label for="balance-method-select">Method</label>
                                    <select id="balance-method-select">
                                        <option value="memory">Memory</option>
                                        <option value="cpu">CPU</option>
                                        <option value="disk">Disk</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="balance-mode-select">Mode</label>
                                    <select id="balance-mode-select">
                                        <option value="used">Used Resources</option>
                                        <option value="assigned">Assigned Resources</option>
                                        <option value="psi">PSI (Pressure)</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="balanciness-input">Balanciness Threshold (%)</label>
                                    <input type="range" id="balanciness-input" min="1" max="50" value="5">
                                    <span class="range-value" id="balanciness-value">5%</span>
                                </div>
                                <div class="form-group">
                                    <label for="memory-threshold-input">Memory Threshold (%)</label>
                                    <input type="range" id="memory-threshold-input" min="50" max="100" value="75">
                                    <span class="range-value" id="memory-threshold-value">75%</span>
                                </div>
                                <button type="submit" class="btn btn-primary">Save Settings</button>
                            </form>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3>Manual Actions</h3>
                        </div>
                        <div class="card-body">
                            <div class="action-buttons">
                                <button class="btn btn-primary btn-large" onclick="triggerRebalance()">
                                    <span class="btn-icon">‚ö°</span>
                                    <span class="btn-text">Trigger Rebalance</span>
                                </button>
                                <button class="btn btn-secondary btn-large" onclick="triggerDryRun()">
                                    <span class="btn-icon">üîç</span>
                                    <span class="btn-text">Dry Run (Simulate)</span>
                                </button>
                                <button class="btn btn-secondary btn-large" onclick="getBestNode()">
                                    <span class="btn-icon">üéØ</span>
                                    <span class="btn-text">Get Best Node</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3>Service Control</h3>
                        </div>
                        <div class="card-body">
                            <div class="service-control">
                                <div class="service-status-large" id="service-status-large">
                                    <span class="status-dot"></span>
                                    <span class="status-text">Checking...</span>
                                </div>
                                <div class="action-buttons">
                                    <button class="btn btn-success" onclick="startService()">Start</button>
                                    <button class="btn btn-warning" onclick="restartService()">Restart</button>
                                    <button class="btn btn-danger" onclick="stopService()">Stop</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Rules Page -->
            <section class="page" id="page-rules">
                <header class="page-header">
                    <h1>Rules & Policies</h1>
                </header>

                <div class="rules-grid">
                    <div class="card">
                        <div class="card-header">
                            <h3>üîó Affinity Groups</h3>
                            <span class="badge" id="affinity-count">0</span>
                        </div>
                        <div class="card-body">
                            <div class="rules-list" id="affinity-list">
                                <p class="empty-state">No affinity groups defined</p>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3>üîÄ Anti-Affinity Groups</h3>
                            <span class="badge" id="anti-affinity-count">0</span>
                        </div>
                        <div class="card-body">
                            <div class="rules-list" id="anti-affinity-list">
                                <p class="empty-state">No anti-affinity groups defined</p>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3>üìå Pinned VMs</h3>
                            <span class="badge" id="pinned-count">0</span>
                        </div>
                        <div class="card-body">
                            <div class="rules-list" id="pinned-list">
                                <p class="empty-state">No pinned VMs</p>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3>üö´ Ignored VMs</h3>
                            <span class="badge" id="ignored-count">0</span>
                        </div>
                        <div class="card-body">
                            <div class="rules-list" id="ignored-list">
                                <p class="empty-state">No ignored VMs</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Logs Page -->
            <section class="page" id="page-logs">
                <header class="page-header">
                    <h1>Logs & <em>Tasks</em></h1>
                    <div class="header-actions">
                        <button class="btn btn-secondary" onclick="refreshLogs()">
                            <span>üîÑ</span> Refresh
                        </button>
                    </div>
                </header>
                
                <!-- Log Tabs -->
                <div class="log-tabs">
                    <button class="log-tab active" data-tab="proxlb" onclick="switchLogTab('proxlb')">
                        üìã ProxLB Logs
                    </button>
                    <button class="log-tab" data-tab="tasks" onclick="switchLogTab('tasks')">
                        ‚ö° Cluster Tasks
                    </button>
                    <button class="log-tab" data-tab="migrations" onclick="switchLogTab('migrations')">
                        üîÑ Migrations
                    </button>
                </div>
                
                <!-- Log Summary -->
                <div class="log-summary" id="log-summary">
                    <!-- Summary will be populated -->
                </div>
                
                <!-- Filter Bar -->
                <div class="log-filter-bar">
                    <div class="filter-group">
                        <label>Level</label>
                        <select class="filter-select" id="log-level-filter" onchange="filterLogs()">
                            <option value="">All Levels</option>
                            <option value="INFO">INFO</option>
                            <option value="WARNING">WARNING</option>
                            <option value="ERROR">ERROR</option>
                            <option value="DEBUG">DEBUG</option>
                        </select>
                    </div>
                    <div class="filter-group" id="task-status-group" style="display: none;">
                        <label>Status</label>
                        <select class="filter-select" id="task-status-filter" onchange="filterTasks()">
                            <option value="">All Status</option>
                            <option value="running">Running</option>
                            <option value="ok">Completed</option>
                            <option value="error">Failed</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Lines</label>
                        <select class="filter-select" id="log-lines-filter" onchange="filterLogs()">
                            <option value="50">50</option>
                            <option value="100" selected>100</option>
                            <option value="200">200</option>
                            <option value="500">500</option>
                        </select>
                    </div>
                    <label class="toggle-label">
                        <input type="checkbox" id="auto-scroll" checked>
                        Auto-scroll
                    </label>
                </div>

                <!-- ProxLB Logs Tab Content -->
                <div class="log-tab-content active" id="tab-proxlb">
                    <div class="log-container">
                        <div class="log-viewer" id="log-viewer">Loading logs...</div>
                    </div>
                </div>
                
                <!-- Cluster Tasks Tab Content -->
                <div class="log-tab-content" id="tab-tasks">
                    <div class="tasks-container">
                        <table class="data-table" id="tasks-table">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Type</th>
                                    <th>Description</th>
                                    <th>Node</th>
                                    <th>Status</th>
                                    <th>Duration</th>
                                </tr>
                            </thead>
                            <tbody id="tasks-tbody">
                                <!-- Tasks will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Migrations Tab Content -->
                <div class="log-tab-content" id="tab-migrations">
                    <div class="migrations-container">
                        <table class="data-table" id="migrations-table">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Guest</th>
                                    <th>From</th>
                                    <th>To</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="migrations-tbody">
                                <!-- Migrations will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Config Page -->
            <section class="page" id="page-config">
                <header class="page-header">
                    <h1>Configuration</h1>
                    <div class="header-actions">
                        <button class="btn btn-primary" onclick="saveConfig()">
                            <span>üíæ</span> Save & Restart
                        </button>
                    </div>
                </header>

                <div class="config-grid">
                    <!-- Proxmox API Settings -->
                    <div class="card">
                        <div class="card-header">
                            <h3>üîå Proxmox API Connection</h3>
                            <span class="info-icon" title="Configure how ProxLB connects to your Proxmox cluster API">‚ÑπÔ∏è</span>
                        </div>
                        <div class="card-body">
                            <p class="section-desc">Connection settings for the Proxmox VE API. ProxLB uses this to monitor resources and migrate VMs.</p>
                            <form class="settings-form" id="api-config-form">
                                <div class="form-group">
                                    <label for="cfg-hosts">API Hosts <span class="info-icon" title="IP addresses or hostnames of your Proxmox nodes. ProxLB will try each host in order until one responds.">‚ÑπÔ∏è</span></label>
                                    <input type="text" id="cfg-hosts" placeholder="10.80.11.11, 10.80.11.12, 10.80.11.13">
                                    <small class="form-hint">Comma-separated list of Proxmox node IPs or hostnames</small>
                                </div>
                                <div class="form-group">
                                    <label for="cfg-user">Username <span class="info-icon" title="Proxmox user with VM migration permissions. Format: user@realm (e.g., proxlb@pve or admin@pam)">‚ÑπÔ∏è</span></label>
                                    <input type="text" id="cfg-user" placeholder="proxlb@pve">
                                    <small class="form-hint">Proxmox user with VM.Migrate and VM.Monitor permissions</small>
                                </div>
                                <div class="form-group">
                                    <label for="cfg-pass">Password <span class="info-icon" title="Password for the Proxmox API user">‚ÑπÔ∏è</span></label>
                                    <input type="password" id="cfg-pass" placeholder="********">
                                    <small class="form-hint">Leave blank to keep current password</small>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="cfg-timeout">Timeout <span class="info-icon" title="How long to wait for API responses before timing out">‚ÑπÔ∏è</span></label>
                                        <input type="number" id="cfg-timeout" min="1" max="60" value="10">
                                        <small class="form-hint">API request timeout in seconds</small>
                                    </div>
                                    <div class="form-group">
                                        <label>SSL Verification <span class="info-icon" title="Enable to verify SSL certificates. Disable for self-signed certificates.">‚ÑπÔ∏è</span></label>
                                        <label class="toggle">
                                            <input type="checkbox" id="cfg-ssl">
                                            <span class="toggle-slider"></span>
                                        </label>
                                        <small class="form-hint">Verify SSL certs (disable for self-signed)</small>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Cluster Settings -->
                    <div class="card">
                        <div class="card-header">
                            <h3>üñ•Ô∏è Cluster Settings</h3>
                            <span class="info-icon" title="Control which nodes participate in load balancing">‚ÑπÔ∏è</span>
                        </div>
                        <div class="card-body">
                            <p class="section-desc">Define which nodes are included in balancing and set cluster-wide options.</p>
                            <form class="settings-form" id="cluster-config-form">
                                <div class="form-group">
                                    <label for="cfg-maintenance-nodes">Maintenance Nodes <span class="info-icon" title="Nodes currently in maintenance mode. VMs will be migrated OFF these nodes to other available nodes. Use this when you need to reboot or update a node.">‚ÑπÔ∏è</span></label>
                                    <input type="text" id="cfg-maintenance-nodes" placeholder="pcdc-1-prox01">
                                    <small class="form-hint">VMs will be migrated away from these nodes (for reboots/updates)</small>
                                </div>
                                <div class="form-group">
                                    <label for="cfg-ignore-nodes">Ignored Nodes <span class="info-icon" title="Nodes completely excluded from load balancing. VMs on these nodes will NOT be migrated, and no VMs will be migrated TO these nodes. Use for special-purpose nodes.">‚ÑπÔ∏è</span></label>
                                    <input type="text" id="cfg-ignore-nodes" placeholder="backup-node, dev-node">
                                    <small class="form-hint">These nodes are excluded from all balancing operations</small>
                                </div>
                                <div class="form-group">
                                    <label>Overprovisioning <span class="info-icon" title="When enabled, ProxLB considers assigned/configured resources rather than actual usage. Useful when VMs don't always use their full allocation.">‚ÑπÔ∏è</span></label>
                                    <label class="toggle">
                                        <input type="checkbox" id="cfg-overprovisioning" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <small class="form-hint">Allow VMs to be allocated more resources than physically available</small>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Balancing Settings -->
                    <div class="card">
                        <div class="card-header">
                            <h3>‚öñÔ∏è Balancing Settings</h3>
                            <span class="info-icon" title="Configure how VMs are distributed across nodes">‚ÑπÔ∏è</span>
                        </div>
                        <div class="card-body">
                            <p class="section-desc">Control how ProxLB decides when and how to migrate VMs for optimal resource distribution.</p>
                            <form class="settings-form" id="balancing-config-form">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Enable Balancing <span class="info-icon" title="Master switch for automatic load balancing. When disabled, no automatic migrations occur.">‚ÑπÔ∏è</span></label>
                                        <label class="toggle">
                                            <input type="checkbox" id="cfg-balance-enable" checked>
                                            <span class="toggle-slider"></span>
                                        </label>
                                        <small class="form-hint">Turn automatic balancing on/off</small>
                                    </div>
                                    <div class="form-group">
                                        <label>Live Migration <span class="info-icon" title="Migrate VMs while they're running (no downtime). If disabled, VMs are stopped before migration.">‚ÑπÔ∏è</span></label>
                                        <label class="toggle">
                                            <input type="checkbox" id="cfg-live" checked>
                                            <span class="toggle-slider"></span>
                                        </label>
                                        <small class="form-hint">Migrate running VMs without downtime</small>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="cfg-method">Balancing Method <span class="info-icon" title="Which resource to optimize: Memory (RAM usage), CPU (processor usage), or Disk (storage I/O)">‚ÑπÔ∏è</span></label>
                                        <select id="cfg-method">
                                            <option value="memory">Memory</option>
                                            <option value="cpu">CPU</option>
                                            <option value="disk">Disk</option>
                                        </select>
                                        <small class="form-hint">Primary resource to balance across nodes</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="cfg-mode">Balancing Mode <span class="info-icon" title="Used: actual real-time usage. Assigned: configured/allocated resources. PSI: Linux Pressure Stall Information (advanced)">‚ÑπÔ∏è</span></label>
                                        <select id="cfg-mode">
                                            <option value="used">Used Resources</option>
                                            <option value="assigned">Assigned Resources</option>
                                            <option value="psi">PSI (Pressure)</option>
                                        </select>
                                        <small class="form-hint">How to measure resource consumption</small>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="cfg-balanciness">Balanciness Threshold <span class="info-icon" title="Minimum percentage difference between nodes required to trigger migration. Lower = more aggressive balancing. Higher = fewer migrations.">‚ÑπÔ∏è</span></label>
                                    <div class="range-group">
                                        <input type="range" id="cfg-balanciness" min="1" max="50" value="5">
                                        <span class="range-value" id="cfg-balanciness-value">5%</span>
                                    </div>
                                    <small class="form-hint">Min difference between nodes to trigger migration (lower = more migrations)</small>
                                </div>
                                <div class="form-group">
                                    <label for="cfg-memory-threshold">Memory Threshold <span class="info-icon" title="Node memory usage percentage that triggers rebalancing. When a node exceeds this, VMs may be migrated away.">‚ÑπÔ∏è</span></label>
                                    <div class="range-group">
                                        <input type="range" id="cfg-memory-threshold" min="50" max="100" value="75">
                                        <span class="range-value" id="cfg-memory-threshold-value">75%</span>
                                    </div>
                                    <small class="form-hint">Migrate VMs when node memory exceeds this level</small>
                                </div>
                                <div class="form-group">
                                    <label for="cfg-balance-types">Balance Types <span class="info-icon" title="Select which guest types to include in load balancing. VMs = QEMU virtual machines. Containers = LXC containers.">‚ÑπÔ∏è</span></label>
                                    <div class="checkbox-group">
                                        <label class="checkbox-label">
                                            <input type="checkbox" id="cfg-balance-vm" checked> VMs (QEMU)
                                        </label>
                                        <label class="checkbox-label">
                                            <input type="checkbox" id="cfg-balance-ct" checked> Containers (LXC)
                                        </label>
                                    </div>
                                    <small class="form-hint">Which guest types to include in balancing</small>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Enforce Affinity <span class="info-icon" title="Strictly enforce affinity rules. VMs with affinity tags must stay together on the same node.">‚ÑπÔ∏è</span></label>
                                        <label class="toggle">
                                            <input type="checkbox" id="cfg-enforce-affinity">
                                            <span class="toggle-slider"></span>
                                        </label>
                                        <small class="form-hint">Keep affinity-tagged VMs together</small>
                                    </div>
                                    <div class="form-group">
                                        <label>With Local Disks <span class="info-icon" title="Include VMs with local storage in migrations. Requires copying disk data which takes longer.">‚ÑπÔ∏è</span></label>
                                        <label class="toggle">
                                            <input type="checkbox" id="cfg-local-disks" checked>
                                            <span class="toggle-slider"></span>
                                        </label>
                                        <small class="form-hint">Migrate VMs even if they use local storage</small>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>With Conntrack <span class="info-icon" title="Preserve network connection tracking state during migration. Keeps established connections alive.">‚ÑπÔ∏è</span></label>
                                        <label class="toggle">
                                            <input type="checkbox" id="cfg-conntrack" checked>
                                            <span class="toggle-slider"></span>
                                        </label>
                                        <small class="form-hint">Preserve active network connections</small>
                                    </div>
                                    <div class="form-group">
                                        <label>Larger Guests First <span class="info-icon" title="Migrate larger VMs (more RAM) first. Can help distribute load faster but may cause longer individual migrations.">‚ÑπÔ∏è</span></label>
                                        <label class="toggle">
                                            <input type="checkbox" id="cfg-larger-first">
                                            <span class="toggle-slider"></span>
                                        </label>
                                        <small class="form-hint">Prioritize migrating bigger VMs first</small>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Parallel Migrations <span class="info-icon" title="Migrate multiple VMs simultaneously. Faster but uses more network bandwidth and resources.">‚ÑπÔ∏è</span></label>
                                        <label class="toggle">
                                            <input type="checkbox" id="cfg-parallel">
                                            <span class="toggle-slider"></span>
                                        </label>
                                        <small class="form-hint">Migrate multiple VMs at once</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="cfg-parallel-jobs">Parallel Jobs <span class="info-icon" title="Maximum number of simultaneous migrations when parallel is enabled.">‚ÑπÔ∏è</span></label>
                                        <input type="number" id="cfg-parallel-jobs" min="1" max="10" value="1">
                                        <small class="form-hint">Max concurrent migrations</small>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="cfg-max-validation">Max Job Validation <span class="info-icon" title="Maximum time in seconds to wait for a migration job to complete before timing out.">‚ÑπÔ∏è</span></label>
                                    <input type="number" id="cfg-max-validation" min="60" max="7200" value="1800">
                                    <small class="form-hint">Migration timeout in seconds (1800 = 30 minutes)</small>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Service Settings -->
                    <div class="card">
                        <div class="card-header">
                            <h3>üîÑ Service Settings</h3>
                            <span class="info-icon" title="Configure the ProxLB background service behavior">‚ÑπÔ∏è</span>
                        </div>
                        <div class="card-body">
                            <p class="section-desc">Control how often ProxLB runs and its logging behavior.</p>
                            <form class="settings-form" id="service-config-form">
                                <div class="form-group">
                                    <label>Daemon Mode <span class="info-icon" title="Run ProxLB as a continuous background service. When enabled, it runs on a schedule. When disabled, it runs once and exits.">‚ÑπÔ∏è</span></label>
                                    <label class="toggle">
                                        <input type="checkbox" id="cfg-daemon" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <small class="form-hint">Run continuously in background (recommended)</small>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="cfg-schedule-interval">Schedule Interval <span class="info-icon" title="How often ProxLB checks cluster balance and performs migrations if needed.">‚ÑπÔ∏è</span></label>
                                        <input type="number" id="cfg-schedule-interval" min="1" max="24" value="1">
                                        <small class="form-hint">How often to check balance</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="cfg-schedule-format">Interval Format <span class="info-icon" title="Time unit for the schedule interval: hours or minutes.">‚ÑπÔ∏è</span></label>
                                        <select id="cfg-schedule-format">
                                            <option value="hours">Hours</option>
                                            <option value="minutes">Minutes</option>
                                        </select>
                                        <small class="form-hint">Hours or minutes</small>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Delay Before Start <span class="info-icon" title="Wait before the first balancing run after service starts. Useful to let the cluster stabilize after boot.">‚ÑπÔ∏è</span></label>
                                    <label class="toggle">
                                        <input type="checkbox" id="cfg-delay-enable">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <small class="form-hint">Wait before first run (useful after cluster boot)</small>
                                </div>
                                <div class="form-row" id="delay-settings" style="display: none;">
                                    <div class="form-group">
                                        <label for="cfg-delay-time">Delay Time</label>
                                        <input type="number" id="cfg-delay-time" min="1" max="60" value="1">
                                    </div>
                                    <div class="form-group">
                                        <label for="cfg-delay-format">Delay Format</label>
                                        <select id="cfg-delay-format">
                                            <option value="hours">Hours</option>
                                            <option value="minutes">Minutes</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="cfg-log-level">Log Level <span class="info-icon" title="Controls log verbosity. DEBUG: everything. INFO: normal operations. WARNING: potential issues. ERROR: only errors.">‚ÑπÔ∏è</span></label>
                                    <select id="cfg-log-level">
                                        <option value="DEBUG">DEBUG (verbose)</option>
                                        <option value="INFO" selected>INFO (normal)</option>
                                        <option value="WARNING">WARNING (less)</option>
                                        <option value="ERROR">ERROR (minimal)</option>
                                    </select>
                                    <small class="form-hint">How much detail to log</small>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </section>


            <!-- Settings Section (Admin Only) -->
            <section class="page" id="page-settings">
                <div class="section-header">
                    <h1>System <em>Settings</em></h1>
                </div>
                
                <div class="settings-tabs">
                    <button class="settings-tab active" data-settings-tab="smtp" onclick="showSettingsTab('smtp')">
                        üìß SMTP / Email
                    </button>
                    <button class="settings-tab" data-settings-tab="security" onclick="showSettingsTab('security')">
                        üîí Security
                    </button>
                </div>
                
                <!-- SMTP Settings Tab -->
                <div class="settings-tab-content active" id="settings-smtp">
                    <div class="card">
                        <h3>üìß SMTP Relay Configuration</h3>
                        <p class="card-description">Configure email settings for password resets and notifications.</p>
                        
                        <form id="smtp-form" onsubmit="saveSMTPSettings(event)">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>SMTP Host</label>
                                    <input type="text" class="form-input" id="smtp-host" placeholder="smtp.example.com" required>
                                </div>
                                <div class="form-group">
                                    <label>Port</label>
                                    <input type="number" class="form-input" id="smtp-port" value="587">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Username</label>
                                    <input type="text" class="form-input" id="smtp-username" placeholder="username@example.com">
                                </div>
                                <div class="form-group">
                                    <label>Password</label>
                                    <input type="password" class="form-input" id="smtp-password" placeholder="Enter password">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>From Email Address</label>
                                <input type="email" class="form-input" id="smtp-from" placeholder="noreply@example.com" required>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group checkbox-group">
                                    <label>
                                        <input type="checkbox" id="smtp-tls" checked>
                                        Use TLS (STARTTLS)
                                    </label>
                                </div>
                                <div class="form-group checkbox-group">
                                    <label>
                                        <input type="checkbox" id="smtp-ssl">
                                        Use SSL (Direct)
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Test Email Section -->
                            <div class="test-email-section">
                                <label>Test Email Address</label>
                                <div class="test-email-row">
                                    <input type="email" class="form-input" id="smtp-test-email" placeholder="Enter email to send test to...">
                                    <button type="button" class="btn btn-secondary" onclick="sendTestEmail()">
                                        ‚úâÔ∏è Send Test
                                    </button>
                                </div>
                            </div>
                            
                            <div class="form-actions">
                                <button type="button" class="btn btn-secondary" onclick="testSMTPConnection()">
                                    üîå Test Connection
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    üíæ Save Settings
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Email Logs Section -->
                    <div class="card" style="margin-top: 20px;">
                        <div class="card-header-row">
                            <h3>üìã Email Send Logs</h3>
                            <div class="card-actions">
                                <button class="btn btn-sm btn-secondary" onclick="refreshEmailLogs()">
                                    üîÑ Refresh
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="clearEmailLogs()">
                                    üóëÔ∏è Clear Logs
                                </button>
                            </div>
                        </div>
                        
                        <!-- Email Stats -->
                        <div class="email-stats" id="email-stats">
                            <div class="stat-item">
                                <span class="stat-label">Total Sent:</span>
                                <span class="stat-value" id="email-stat-total">0</span>
                            </div>
                            <div class="stat-item success">
                                <span class="stat-label">Success:</span>
                                <span class="stat-value" id="email-stat-success">0</span>
                            </div>
                            <div class="stat-item failed">
                                <span class="stat-label">Failed:</span>
                                <span class="stat-value" id="email-stat-failed">0</span>
                            </div>
                        </div>
                        
                        <!-- Logs Filter -->
                        <div class="logs-filter">
                            <select id="email-log-status-filter" onchange="refreshEmailLogs()">
                                <option value="">All Status</option>
                                <option value="success">Success</option>
                                <option value="failed">Failed</option>
                            </select>
                            <select id="email-log-type-filter" onchange="refreshEmailLogs()">
                                <option value="">All Types</option>
                                <option value="test">Test</option>
                                <option value="password_reset">Password Reset</option>
                                <option value="2fa">2FA</option>
                                <option value="general">General</option>
                            </select>
                        </div>
                        
                        <!-- Logs Table -->
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Timestamp</th>
                                        <th>To</th>
                                        <th>Subject</th>
                                        <th>Type</th>
                                        <th>Status</th>
                                        <th>Message</th>
                                    </tr>
                                </thead>
                                <tbody id="email-logs-body">
                                    <tr>
                                        <td colspan="6" class="empty-state">No email logs yet</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Security Settings Tab -->
                <div class="settings-tab-content" id="settings-security">
                    <div class="card">
                        <h3>üîí Security Settings</h3>
                        <p class="card-description">Configure security options for your installation.</p>
                        
                        <div class="security-info">
                            <div class="info-item">
                                <span class="label">JWT Token Expiry:</span>
                                <span class="value">24 hours</span>
                            </div>
                            <div class="info-item">
                                <span class="label">Password Hashing:</span>
                                <span class="value">bcrypt</span>
                            </div>
                            <div class="info-item">
                                <span class="label">2FA Support:</span>
                                <span class="value">TOTP (Time-based One-Time Password)</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Users Section (Admin Only) -->
            <section class="page" id="page-users">
                <div class="section-header">
                    <h1>User <em>Management</em></h1>
                    <button class="btn btn-primary" onclick="showCreateUserModal()">
                        <span class="btn-icon">‚ûï</span>
                        Add User
                    </button>
                </div>
                
                <div class="users-grid" id="users-list">
                    <!-- Users will be loaded here -->
                </div>
            </section>
        </main>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Confirmation Modal -->
    <div class="modal" id="confirm-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Confirm Action</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p id="modal-message">Are you sure you want to proceed?</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" id="modal-confirm-btn">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Results Modal -->
    <div class="modal-overlay" id="results-modal" style="display: none;">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3 id="results-modal-title">Operation Results</h3>
                <button class="modal-close" onclick="closeResultsModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div id="results-modal-status" class="results-status"></div>
                <div id="results-modal-content" class="results-content"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeResultsModal()">Close</button>
            </div>
        </div>
    </div>

    <script src="/static/js/auth.js?v=25"></script>
    <script src="/static/js/app.js?v=27"></script>
</body>
</html>

